name: Update and Build

on:
  schedule:
    - cron: "15 5 * * *" # Daily nightly update
  workflow_dispatch:

jobs:
  # Ensure sources are up-to-date
  update-sources:
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.check.outputs.any_changed }}
      mesa_rev: ${{ steps.check.outputs.mesa_rev }}
      branch: ${{ steps.set-branch.outputs.branch }}

    steps:
      - name: Set branch
        id: set-branch
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "branch=nightly" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.set-branch.outputs.branch }}

      - uses: cachix/install-nix-action@master
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Install dependencies
        run: nix profile add nixpkgs#nvfetcher nixpkgs#jq nixpkgs#cargo

      - name: Save old versions
        run: |
          cp _sources/generated.json /tmp/old-generated.json 2>/dev/null || echo '{}' > /tmp/old-generated.json

      - name: Run nvfetcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          nvfetcher -o _sources
          nvfetcher -c pkgs/eden-emulator/nvfetcher.toml -o pkgs/eden-emulator/_dependencies

      - name: Check what changed
        id: check
        run: |
          OLD_MESA=$(jq -r '.mesa.version // "none"' /tmp/old-generated.json)
          NEW_MESA=$(jq -r '.mesa.version // "none"' _sources/generated.json)
          echo "mesa_rev=${NEW_MESA:0:7}" >> $GITHUB_OUTPUT

          if ! diff -q /tmp/old-generated.json _sources/generated.json > /dev/null 2>&1; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Cargo.lock for pseudoregalia
        run: |
          VER=$(jq -r '.["pseudoregalia-rando"].version' _sources/generated.json)
          CURRENT=""
          [ -f pkgs/pseudoregalia-rando/.version ] && CURRENT=$(cat pkgs/pseudoregalia-rando/.version)

          if [ "$CURRENT" != "$VER" ]; then
            WORK_DIR=$(mktemp -d)
            curl -sL "https://github.com/pseudoregalia-modding/rando/archive/$VER.tar.gz" | tar xz -C "$WORK_DIR"
            SRC_DIR=$(find "$WORK_DIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)
            (cd "$SRC_DIR" && cargo generate-lockfile)
            cp "$SRC_DIR/Cargo.lock" pkgs/pseudoregalia-rando/Cargo.lock
            echo "$VER" > pkgs/pseudoregalia-rando/.version
            rm -rf "$WORK_DIR"
          fi

      - name: Update pnpm hash for Vencord
        run: |
          echo -n "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" > pkgs/discord/vencord-pnpm-hash.txt

          nix build .#vencord.pnpmDeps --no-link 2> nix-err.log || true
          NEW_HASH=$(awk '/got:/ {print $2}' nix-err.log)

          if [[ $NEW_HASH == sha256-* ]]; then
            echo -n "$NEW_HASH" > pkgs/discord/vencord-pnpm-hash.txt
          else
            echo "Hash could not be scraped:"
            cat nix-err.log
            exit 1
          fi

      - name: Update flake.lock
        if: steps.check.outputs.any_changed == 'true'
        run: nix flake update

      - name: Upload updated sources
        uses: actions/upload-artifact@v4
        with:
          name: updated-sources
          retention-days: 1
          path: |
            _sources/
            pkgs/eden-emulator/_dependencies/
            pkgs/pseudoregalia-rando/Cargo.lock
            pkgs/pseudoregalia-rando/.version
            pkgs/discord/vencord-pnpm-hash.txt
            flake.lock

  # Generate build matrix from packages.json on the target branch
  generate-matrix:
    needs: update-sources
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.update-sources.outputs.branch }}

      - name: Generate matrix from packages.json
        id: set-matrix
        run: |
          MATRIX=$(jq -c . packages.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Build packages from a matrix
  build:
    needs: [update-sources, generate-matrix]
    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }} gitlab.freedesktop.org=${{ secrets.GITLAB_TOKEN }}
    if: needs.update-sources.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.update-sources.outputs.branch }}

      - uses: actions/download-artifact@v4
        with:
          name: updated-sources

      - name: Purge Nix (sometimes Nix persists in a way that prevents Cachix installation)
        if: contains(matrix.runner, 'self-hosted')
        run: |
          sudo rm -rf /nix
          sudo rm -rf ~/.nix-* /root/.nix-*
          sudo rm -rf /etc/nix
          sudo rm -rf /homeless-shelter
        continue-on-error: true

      - uses: cachix/install-nix-action@master
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Build ${{ matrix.name }}
        run: |
          for pkg in ${{ matrix.packages }}; do
            echo "::group::Building $pkg"
            nix build .#$pkg -L -o "result-$pkg"
            echo "::endgroup::"
          done

      - name: Push to Attic
        if: contains(matrix.runner, 'self-hosted')
        env:
          ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
        run: |
          nix profile add nixpkgs#attic-client
          attic login local http://attic:8080 $ATTIC_TOKEN
          attic push tokidoki $(nix-store -qR ./result-*) --ignore-upstream-cache-filter

  # Commit to target branch only when all builds succeed
  commit-changes:
    needs: [update-sources, build]
    if: |
      always() &&
      needs.update-sources.outputs.any_changed == 'true' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.update-sources.outputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          name: updated-sources

      - name: Commit changes
        env:
          MESA_REV: ${{ needs.update-sources.outputs.mesa_rev }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update sources (mesa: $MESA_REV)" || echo "Nothing to commit"
          git push origin ${{ needs.update-sources.outputs.branch }}
