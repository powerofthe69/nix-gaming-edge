# .github/workflows/update.yml
name: Update and Build

on:
  schedule:
    - cron: "0 5 * * *" # Daily at 5 AM UTC (update + build)
    - cron: "0 6 * * 3" # Wednesdays at 6 AM UTC (promote)
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: false
        default: "update-sources"
        type: choice
        options:
          - update-sources
          - promote-to-master

jobs:
  # Ensure sources are up-to-date
  update-sources:
    if: (github.event_name == 'schedule' && github.event.schedule == '0 5 * * *') || (github.event_name == 'workflow_dispatch' && inputs.task == 'update-sources')
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.check.outputs.any_changed }}
      mesa_rev: ${{ steps.check.outputs.mesa_rev }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: nightly

      - uses: cachix/install-nix-action@master
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Install dependencies
        run: nix profile add nixpkgs#nvfetcher nixpkgs#jq nixpkgs#cargo

      - name: Save old versions
        run: |
          cp _sources/generated.json /tmp/old-generated.json 2>/dev/null || echo '{}' > /tmp/old-generated.json

      - name: Run nvfetcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: nvfetcher -o _sources

      - name: Check what changed
        id: check
        run: |
          OLD_MESA=$(jq -r '.mesa.version // "none"' /tmp/old-generated.json)
          NEW_MESA=$(jq -r '.mesa.version // "none"' _sources/generated.json)
          echo "mesa_rev=${NEW_MESA:0:7}" >> $GITHUB_OUTPUT

          if ! diff -q /tmp/old-generated.json _sources/generated.json > /dev/null 2>&1; then
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Cargo.lock for pseudoregalia
        run: |
          VER=$(jq -r '.["pseudoregalia-rando"].version' _sources/generated.json)
          CURRENT=""
          [ -f pkgs/pseudoregalia-rando/.version ] && CURRENT=$(cat pkgs/pseudoregalia-rando/.version)

          if [ "$CURRENT" != "$VER" ]; then
            WORK_DIR=$(mktemp -d)
            curl -sL "https://github.com/pseudoregalia-modding/rando/archive/$VER.tar.gz" | tar xz -C "$WORK_DIR"
            SRC_DIR=$(find "$WORK_DIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)
            (cd "$SRC_DIR" && cargo generate-lockfile)
            cp "$SRC_DIR/Cargo.lock" pkgs/pseudoregalia-rando/Cargo.lock
            echo "$VER" > pkgs/pseudoregalia-rando/.version
            rm -rf "$WORK_DIR"
          fi

      - name: Update flake.lock
        if: steps.check.outputs.any_changed == 'true'
        run: nix flake update

      - name: Upload updated sources
        uses: actions/upload-artifact@v4
        with:
          name: updated-sources
          retention-days: 1
          path: |
            _sources/
            pkgs/pseudoregalia-rando/Cargo.lock
            pkgs/pseudoregalia-rando/.version
            flake.lock

  # Build packages from a matrix
  build:
    needs: update-sources
    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }} gitlab.freedesktop.org=${{ secrets.GITLAB_TOKEN }}
    if: needs.update-sources.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Run heavier (caching) builds on local runners
          - name: mesa
            packages: mesa-git mesa32-git
            runner: [self-hosted, heavy-tasks]

          - name: pseudoregalia
            packages: pseudoregalia-rando
            runner: [self-hosted, light-tasks]

          # Run light builds (tarballs) on GitHub runners
          - name: proton
            packages: proton-cachyos proton-cachyos-x86_64-v2 proton-cachyos-x86_64-v3 proton-cachyos-x86_64-v4
            runner: ubuntu-latest

          - name: vintagestory
            packages: vintagestory vintagestory-stable
            runner: ubuntu-latest

          - name: pokemmo
            packages: pokemmo
            runner: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: nightly

      - uses: actions/download-artifact@v4
        with:
          name: updated-sources

      - uses: cachix/install-nix-action@master
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Build ${{ matrix.name }}
        run: |
          for pkg in ${{ matrix.packages }}; do
            echo "::group::Building $pkg"
            nix build .#$pkg -L
            echo "::endgroup::"
          done

      - name: Push to Attic
        if: contains(matrix.runner, 'self-hosted')
        env:
          ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
        run: |
          nix profile add nixpkgs#attic-client
          attic login local http://attic:8080 $ATTIC_TOKEN
          attic push tokidoki $(nix-store -qR ./result*) --ignore-upstream-cache-filter

  # Commit to nightly only when all builds succeed
  commit-changes:
    needs: [update-sources, build]
    if: |
      always() &&
      needs.update-sources.outputs.any_changed == 'true' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: nightly
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          name: updated-sources

      - name: Commit changes
        env:
          MESA_REV: ${{ needs.update-sources.outputs.mesa_rev }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update sources (mesa: $MESA_REV)" || echo "Nothing to commit"
          git push

  # Merge nightly to master weekly on Wednesdays at 6AM UTC
  promote-to-master:
    if: (github.event_name == 'schedule' && github.event.schedule == '0 6 * * 3') || (github.event_name == 'workflow_dispatch' && inputs.task == 'promote-to-master')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge nightly â†’ master
        run: |
          git fetch origin nightly
          if git merge-base --is-ancestor origin/nightly HEAD; then
            echo "Master is already up to date with nightly"
            exit 0
          fi
          git merge --ff-only origin/nightly || git merge origin/nightly -m "chore: weekly promote from nightly"
          git push origin master
